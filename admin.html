<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>LizOn Admin Panel</title>
  <meta name="theme-color" content="#0b2a1f" />
  <link rel="icon" href="data:,">

  <style>
    :root{
      --bg:#06140f; --card:#0c2019; --line:#1d4a3a;
      --text:#e9f3ef; --muted:#b7c9c2; --gold:#d7b24a;
      --danger:#ff6b6b; --ok:#7CFFB2;
    }
    body{margin:0;font-family:system-ui,Segoe UI,Roboto,Arial;background:var(--bg);color:var(--text);}
    .wrap{max-width:980px;margin:0 auto;padding:22px;}
    .card{background:rgba(12,32,25,.92);border:1px solid var(--line);border-radius:16px;padding:18px;margin-top:16px;}
    .row{display:flex;gap:12px;flex-wrap:wrap;align-items:center}
    .between{display:flex;gap:12px;flex-wrap:wrap;align-items:center;justify-content:space-between}
    .btn{padding:12px 14px;border-radius:12px;border:1px solid var(--line);background:transparent;color:var(--text);cursor:pointer;text-decoration:none;display:inline-flex;align-items:center;gap:8px}
    .btn.primary{border-color:rgba(215,178,74,.7);box-shadow:0 0 0 1px rgba(215,178,74,.25) inset}
    .btn.danger{border-color:rgba(255,107,107,.6)}
    input, select{width:100%;padding:12px;border-radius:12px;border:1px solid var(--line);background:#071a14;color:var(--text);}
    label{display:block;margin-top:10px}
    small{color:var(--muted)}
    .hidden{display:none}
    .hr{height:1px;background:var(--line);margin:14px 0}
    .ok{color:var(--ok)}
    .err{color:var(--danger)}
    .title{font-size:34px;margin:0}
    .tag{display:inline-block;border:1px solid var(--line);padding:6px 10px;border-radius:999px;color:var(--muted);font-size:12px}
  </style>
</head>
<body>
<div class="wrap">
  <div class="between">
    <div>
      <h1 class="title">LizOn Education — Admin Panel</h1>
      <small>Enroll students into one or multiple courses</small>
    </div>
    <a class="btn" href="/index.html">Student Portal</a>
  </div>

  <!-- ADMIN LOGIN -->
  <div class="card" id="loginCard">
    <h2 style="margin-top:0">Admin Login</h2>
    <label>Email
      <input id="email" type="email" placeholder="admin@example.com" autocomplete="email">
    </label>
    <label>Password
      <input id="pass" type="password" placeholder="••••••••" autocomplete="current-password">
    </label>
    <div class="row" style="margin-top:12px">
      <button class="btn primary" id="btnLogin" type="button">Login</button>
      <button class="btn danger" id="btnLogoutLoginCard" type="button">Logout</button>
    </div>
    <p id="msg"></p>
  </div>

  <!-- ADMIN TOOL -->
  <div class="card hidden" id="toolCard">
    <div class="between">
      <div>
        <h2 style="margin:0">Enroll Tool</h2>
        <small id="who"></small>
      </div>
      <div class="row">
        <span class="tag">Admin only</span>
        <button class="btn danger" id="btnLogout" type="button">Logout</button>
      </div>
    </div>

    <div class="hr"></div>

    <p style="margin:0 0 10px 0"><small>
      Best practice: enroll by <b>User ID (UUID)</b> from Supabase → Authentication → Users.
      Email lookup works only if you add <code>profiles.email</code>.
    </small></p>

    <label>Student User ID (UUID) — recommended
      <input id="studentUserId" placeholder="e.g. 3b8f0f9e-....-....-....-........">
    </label>

    <label>OR Student Email (only works if profiles.email exists)
      <input id="studentEmail" placeholder="student@example.com">
    </label>

    <label>Select Course
      <select id="courseSelect"></select>
    </label>

    <label>Join Link (WhatsApp group / Zoom / Meet)
      <input id="joinLink" placeholder="https://chat.whatsapp.com/....">
    </label>

    <label>Class Record Link (Drive / YouTube playlist)
      <input id="recordLink" placeholder="https://drive.google.com/... or https://youtube.com/...">
    </label>

    <label>Status
      <select id="status">
        <option value="active">active</option>
        <option value="paused">paused</option>
      </select>
    </label>

    <div class="row" style="margin-top:12px">
      <button class="btn primary" id="btnEnroll" type="button">Enroll / Add Course</button>
    </div>

    <p id="toolMsg"></p>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script>
/* ========= SUPABASE CONFIG (REPLACE ONLY THESE 2 LINES) ========= */
const SUPABASE_URL = "https://swgerukvltraldtjueih.supabase.co";
const SUPABASE_ANON_KEY = "sb_publishable_RbWdA9MwSVNKqZ-Q4GWN3Q_iiOYFedG";
/* =============================================================== */

const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

const el = id => document.getElementById(id);
const setMsg = (t, ok=true)=>{ el("msg").textContent=t||""; el("msg").className=ok?"ok":"err"; };
const setToolMsg = (t, ok=true)=>{ el("toolMsg").textContent=t||""; el("toolMsg").className=ok?"ok":"err"; };

let adminUser = null;

function escapeHtml(s){
  return String(s || "").replace(/[&<>"']/g, (c) => ({
    "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;"
  }[c]));
}

async function requireAdminOrKick(){
  const { data, error } = await supabase
    .from("profiles")
    .select("role")
    .eq("id", adminUser.id)
    .maybeSingle();

  if(error) throw new Error(error.message);

  const role = (data?.role || "student").toLowerCase();
  if(role !== "admin"){
    await supabase.auth.signOut();
    adminUser = null;
    el("toolCard").classList.add("hidden");
    el("loginCard").classList.remove("hidden");
    throw new Error("Not an admin account.");
  }
}

async function loadCourses(){
  const sel = el("courseSelect");
  sel.innerHTML = `<option>Loading…</option>`;

  const { data, error } = await supabase
    .from("courses")
    .select("id, slug, title")
    .order("id",{ascending:true});

  if(error) throw new Error(error.message);

  sel.innerHTML = data.map(c =>
    `<option value="${c.id}">${escapeHtml((c.slug||"").toUpperCase())} — ${escapeHtml(c.title||"")}</option>`
  ).join("");
}

async function showTool(){
  el("who").textContent = `Logged in as ${adminUser.email}`;
  el("loginCard").classList.add("hidden");
  el("toolCard").classList.remove("hidden");
  setMsg("");
  setToolMsg("Ready.", true);
}

async function hideTool(){
  el("toolCard").classList.add("hidden");
  el("loginCard").classList.remove("hidden");
}

el("btnLogin").addEventListener("click", async ()=>{
  setMsg("Logging in…");
  try{
    const email = el("email").value.trim();
    const password = el("pass").value;
    if(!email || !password) return setMsg("Email + password required.", false);

    const { data, error } = await supabase.auth.signInWithPassword({ email, password });
    if(error) return setMsg(error.message, false);
    if(!data?.session?.user) return setMsg("No session returned.", false);

    adminUser = data.session.user;

    await requireAdminOrKick();
    await loadCourses();
    await showTool();

  }catch(e){
    setMsg(e.message || "Admin login failed.", false);
  }
});

async function doLogout(){
  try{ await supabase.auth.signOut(); }
  finally{ window.location.replace(window.location.pathname); }
}

el("btnLogout").addEventListener("click", doLogout);
el("btnLogoutLoginCard").addEventListener("click", doLogout);

el("btnEnroll").addEventListener("click", async ()=>{
  setToolMsg("Enrolling…");
  try{
    if(!adminUser) throw new Error("Not logged in.");

    // re-check admin role each action (simple safety)
    await requireAdminOrKick();

    const userId = el("studentUserId").value.trim();
    const email = el("studentEmail").value.trim().toLowerCase();
    const course_id = Number(el("courseSelect").value);
    const join_link = el("joinLink").value.trim() || null;
    const record_link = el("recordLink").value.trim() || null;
    const status = el("status").value;

    if(!course_id) return setToolMsg("Course required.", false);
    if(!join_link && !record_link) return setToolMsg("Add Join link or Record link (at least one).", false);

    let targetUserId = userId;

    // If UUID not provided, try email lookup (only works if profiles.email exists)
    if(!targetUserId){
      if(!email) return setToolMsg("Provide Student User ID (UUID) OR Email.", false);

      const { data: prof, error: pErr } = await supabase
        .from("profiles")
        .select("id")
        .ilike("email", email)
        .maybeSingle();

      if(pErr){
        throw new Error("Email lookup failed. Add profiles.email OR use Student User ID (UUID).");
      }
      if(!prof?.id){
        throw new Error("Student not found. Make sure profile exists or use Student User ID (UUID).");
      }
      targetUserId = prof.id;
    }

    const { error } = await supabase
      .from("enrollments")
      .upsert([{
        user_id: targetUserId,
        course_id,
        status,
        join_link,
        record_link
      }], { onConflict: "user_id,course_id" });

    if(error) throw new Error(error.message);

    setToolMsg("Enrolled ✅ (course added/updated).", true);
    el("joinLink").value = "";
    el("recordLink").value = "";

  }catch(e){
    setToolMsg(e.message || "Enroll failed.", false);
  }
});

/* BFCache / back-button fix */
window.addEventListener("pageshow", async (e)=>{
  if(e.persisted) return window.location.reload();

  const { data } = await supabase.auth.getSession();
  if(data?.session?.user){
    adminUser = data.session.user;
    try{
      await requireAdminOrKick();
      await loadCourses();
      await showTool();
    }catch(_){
      await hideTool();
    }
  }else{
    adminUser = null;
    await hideTool();
  }
});
</script>
</body>
</html>
