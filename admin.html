<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>LizOn Admin Panel</title>
  <meta name="theme-color" content="#0b2a1f" />
  <link rel="icon" href="data:,">

  <style>
    :root{
      --bg:#06140f; --card:#0c2019; --line:#1d4a3a;
      --text:#e9f3ef; --muted:#b7c9c2; --gold:#d7b24a;
      --danger:#ff6b6b; --ok:#7CFFB2;
    }
    body{margin:0;font-family:system-ui,Segoe UI,Roboto,Arial;background:var(--bg);color:var(--text);}
    .wrap{max-width:980px;margin:0 auto;padding:22px;}
    .card{background:rgba(12,32,25,.92);border:1px solid var(--line);border-radius:16px;padding:18px;margin-top:16px;}
    .row{display:flex;gap:12px;flex-wrap:wrap;align-items:center}
    .between{display:flex;gap:12px;flex-wrap:wrap;align-items:center;justify-content:space-between}
    .btn{padding:12px 14px;border-radius:12px;border:1px solid var(--line);background:transparent;color:var(--text);cursor:pointer;text-decoration:none;display:inline-flex;align-items:center;gap:8px}
    .btn.primary{border-color:rgba(215,178,74,.7);box-shadow:0 0 0 1px rgba(215,178,74,.25) inset}
    .btn.danger{border-color:rgba(255,107,107,.6)}
    input, select{width:100%;padding:12px;border-radius:12px;border:1px solid var(--line);background:#071a14;color:var(--text);}
    label{display:block;margin-top:10px}
    small{color:var(--muted)}
    .hidden{display:none}
    .hr{height:1px;background:var(--line);margin:14px 0}
    .ok{color:var(--ok)}
    .err{color:var(--danger)}
    .title{font-size:34px;margin:0}
    .tag{display:inline-block;border:1px solid var(--line);padding:6px 10px;border-radius:999px;color:var(--muted);font-size:12px}
  </style>
</head>
<body>
<div class="wrap">
  <div class="between">
    <div>
      <h1 class="title">LizOn Education — Admin Panel</h1>
      <small>Enroll students into one or multiple courses</small>
    </div>
    <a class="btn" href="/index.html">Student Portal</a>
  </div>

  <!-- ADMIN LOGIN -->
  <div class="card" id="loginCard">
    <h2 style="margin-top:0">Admin Login</h2>
    <label>Email
      <input id="email" type="email" placeholder="admin@example.com" autocomplete="email">
    </label>
    <label>Password
      <input id="pass" type="password" placeholder="••••••••" autocomplete="current-password">
    </label>
    <div class="row" style="margin-top:12px">
      <button class="btn primary" id="btnLogin" type="button">Login</button>
      <button class="btn danger" id="btnLogout" type="button">Logout</button>
    </div>
    <p id="msg"></p>
  </div>

  <!-- ADMIN TOOL -->
  <div class="card hidden" id="toolCard">
    <div class="between">
      <div>
        <h2 style="margin:0">Enroll Tool</h2>
        <small id="who"></small>
      </div>
      <span class="tag">Admin only</span>
    </div>

    <div class="hr"></div>

    <label>Student Email (must be signed up already)
      <input id="studentEmail" placeholder="student@example.com">
    </label>

    <label>Select Course
      <select id="courseSelect"></select>
    </label>

    <label>Join Link (WhatsApp group / Zoom / Meet)
      <input id="joinLink" placeholder="https://chat.whatsapp.com/....">
    </label>

    <label>Class Record Link (Drive / YouTube playlist)
      <input id="recordLink" placeholder="https://drive.google.com/... or https://youtube.com/...">
    </label>

    <label>Status
      <select id="status">
        <option value="active">active</option>
        <option value="paused">paused</option>
      </select>
    </label>

    <div class="row" style="margin-top:12px">
      <button class="btn primary" id="btnEnroll" type="button">Enroll / Add Course</button>
    </div>

    <p id="toolMsg"></p>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script>
/* ========= SUPABASE CONFIG (REPLACE ONLY THESE 2 LINES) ========= */
const SUPABASE_URL = "https://swgerukvltraldtjueih.supabase.co";
const SUPABASE_ANON_KEY = "sb_publishable_RbWdA9MwSVNKqZ-Q4GWN3Q_iiOYFedG";
/* =============================================================== */

const sb = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

const el = id => document.getElementById(id);
const setMsg = (t, ok=true)=>{ el("msg").textContent=t||""; el("msg").className=ok?"ok":"err"; };
const setToolMsg = (t, ok=true)=>{ el("toolMsg").textContent=t||""; el("toolMsg").className=ok?"ok":"err"; };

let adminUser = null;

function escapeHtml(s){
  return String(s || "").replace(/[&<>"']/g, (c) => ({
    "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;"
  }[c]));
}

async function requireAdmin(){
  // Check profile.role
  const { data, error } = await sb.from("profiles").select("role").eq("id", adminUser.id).maybeSingle();
  if(error) throw new Error(error.message);
  const role = data?.role || "student";
  if(role !== "admin"){
    // Kick out if not admin
    await sb.auth.signOut();
    adminUser = null;
    el("toolCard").classList.add("hidden");
    el("loginCard").classList.remove("hidden");
    throw new Error("Not an admin account.");
  }
}

async function loadCourses(){
  const sel = el("courseSelect");
  sel.innerHTML = `<option>Loading…</option>`;

  const { data, error } = await sb.from("courses").select("id, slug, title").order("id",{ascending:true});
  if(error) throw new Error(error.message);

  sel.innerHTML = data.map(c=>`<option value="${c.id}">${escapeHtml((c.slug||"").toUpperCase())} — ${escapeHtml(c.title||"")}</option>`).join("");
}

el("btnLogin").addEventListener("click", async ()=>{
  setMsg("Logging in…");
  try{
    const email = el("email").value.trim();
    const password = el("pass").value;
    if(!email || !password) return setMsg("Email + password required.", false);

    const { data, error } = await sb.auth.signInWithPassword({ email, password });
    if(error) return setMsg(error.message, false);
    if(!data?.session?.user) return setMsg("No session returned.", false);

    adminUser = data.session.user;

    await requireAdmin();
    await loadCourses();

    el("who").textContent = `Logged in as ${adminUser.email}`;
    el("loginCard").classList.add("hidden");
    el("toolCard").classList.remove("hidden");
    setMsg("");
    setToolMsg("Ready.", true);

  }catch(e){
    setMsg(e.message || "Admin login failed.", false);
  }
});

el("btnLogout").addEventListener("click", async ()=>{
  try{ await sb.auth.signOut(); }
  finally{ window.location.replace(window.location.pathname); }
});

el("btnEnroll").addEventListener("click", async ()=>{
  setToolMsg("Enrolling…");
  try{
    const email = el("studentEmail").value.trim().toLowerCase();
    const course_id = Number(el("courseSelect").value);
    const join_link = el("joinLink").value.trim() || null;
    const record_link = el("recordLink").value.trim() || null;
    const status = el("status").value;

    if(!email) return setToolMsg("Student email required.", false);
    if(!course_id) return setToolMsg("Course required.", false);
    if(!join_link && !record_link) return setToolMsg("Add Join link or Record link (at least one).", false);

    // Find user by profiles (student must exist there)
    const { data: prof, error: pErr } = await sb.from("profiles").select("id").ilike("email", email).maybeSingle();
    // If your profiles table doesn't have email column, you must add it OR enroll by user_id manually.
    if(pErr) throw new Error("profiles.email not found or blocked. Add email column to profiles OR enroll by user_id.");
    if(!prof?.id) throw new Error("Student not found in profiles. Make sure the student signed up and profile row exists.");

    const user_id = prof.id;

    const { error } = await sb.from("enrollments").upsert([{
      user_id,
      course_id,
      status,
      join_link,
      record_link
    }], { onConflict: "user_id,course_id" });

    if(error) throw new Error(error.message);

    setToolMsg("Enrolled ✅ (course added/updated).", true);
    el("joinLink").value = "";
    el("recordLink").value = "";

  }catch(e){
    setToolMsg(e.message || "Enroll failed.", false);
  }
});

// If page returns from BFCache, re-check session
window.addEventListener("pageshow", async ()=>{
  const { data } = await sb.auth.getSession();
  if(data?.session?.user){
    adminUser = data.session.user;
    try{
      await requireAdmin();
      await loadCourses();
      el("who").textContent = `Logged in as ${adminUser.email}`;
      el("loginCard").classList.add("hidden");
      el("toolCard").classList.remove("hidden");
    }catch(e){
      // ignore, requireAdmin will kick out
    }
  }
});
</script>
</body>
</html>
