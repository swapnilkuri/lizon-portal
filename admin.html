<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>LizOn Admin Panel</title>
  <meta name="theme-color" content="#0b2a1f" />
  <link rel="icon" href="data:,">
  <style>
    :root{
      --bg:#06140f; --card:#0c2019; --line:#1d4a3a;
      --text:#e9f3ef; --muted:#b7c9c2; --gold:#d7b24a;
      --danger:#ff6b6b; --ok:#7CFFB2;
    }
    body{margin:0;font-family:system-ui,Segoe UI,Roboto,Arial;background:var(--bg);color:var(--text);}
    .wrap{max-width:980px;margin:0 auto;padding:22px;}
    .card{background:rgba(12,32,25,.92);border:1px solid var(--line);border-radius:16px;padding:18px;margin-top:16px;}
    .row{display:flex;gap:12px;flex-wrap:wrap;align-items:center}
    .between{display:flex;gap:12px;flex-wrap:wrap;align-items:center;justify-content:space-between}
    .btn{padding:12px 14px;border-radius:12px;border:1px solid var(--line);background:transparent;color:var(--text);cursor:pointer}
    .btn.primary{border-color:rgba(215,178,74,.7);box-shadow:0 0 0 1px rgba(215,178,74,.25) inset}
    .btn.danger{border-color:rgba(255,107,107,.6)}
    input, select{
      width:100%;padding:12px;border-radius:12px;border:1px solid var(--line);
      background:#071a14;color:var(--text);
    }
    label{display:block;margin-top:10px}
    small{color:var(--muted)}
    .hidden{display:none}
    .hr{height:1px;background:var(--line);margin:14px 0}
    .ok{color:var(--ok)}
    .err{color:var(--danger)}
    table{width:100%;border-collapse:collapse}
    th,td{border-bottom:1px solid var(--line);padding:10px;text-align:left}
    .tag{display:inline-block;border:1px solid var(--line);padding:6px 10px;border-radius:999px;color:var(--muted)}
  </style>
</head>

<body>
<div class="wrap">
  <div class="between">
    <div>
      <h1 style="margin:0">LizOn Education — Admin Panel</h1>
      <small>Enroll students into one or multiple courses</small>
    </div>
    <a class="btn" href="/index.html">Student Portal</a>
  </div>

  <!-- LOGIN -->
  <div class="card" id="loginCard">
    <h2>Admin Login</h2>
    <label>Email
      <input id="email" type="email" placeholder="admin@example.com">
    </label>
    <label>Password
      <input id="pass" type="password" placeholder="••••••••">
    </label>
    <div class="row" style="margin-top:12px">
      <button class="btn primary" id="btnLogin">Login</button>
    </div>
    <p id="msg"></p>
  </div>

  <!-- PANEL -->
  <div class="card hidden" id="panelCard">
    <div class="between">
      <div>
        <h2 style="margin:0">Admin Tools</h2>
        <small id="who"></small>
      </div>
      <button class="btn danger" id="btnLogout">Logout</button>
    </div>

    <div class="hr"></div>

    <h3 style="margin:0 0 10px 0">Quick Enroll (manual)</h3>

    <div class="row">
      <div style="flex:1;min-width:260px">
        <label>Student user_id (UUID)
          <input id="studentId" placeholder="paste profiles.id of student">
        </label>
      </div>
      <div style="flex:1;min-width:220px">
        <label>Course
          <select id="courseId"></select>
        </label>
      </div>
      <div style="min-width:160px">
        <label>Status
          <select id="status">
            <option value="active">active</option>
            <option value="paused">paused</option>
          </select>
        </label>
      </div>
    </div>

    <div class="row" style="margin-top:12px">
      <button class="btn primary" id="btnEnroll">Enroll</button>
      <span id="enrollMsg"></span>
    </div>

    <div class="hr"></div>

    <h3 style="margin:0 0 10px 0">Recent Enrollments</h3>
    <div id="enrollmentsBox"><small>Loading…</small></div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script>
console.log("admin.html JS running ✅");

/* ========= SUPABASE CONFIG ========= */
const SUPABASE_URL = "https://swgerukvltraldtjueih.supabase.co";
const SUPABASE_ANON_KEY = "sb_publishable_RbWdA9MwSVNKqZ-Q4GWN3Q_iiOYFedG"; // replace

// IMPORTANT: use a different variable name so we never “redecalre supabase”
const sb = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

const el = id => document.getElementById(id);
const setMsg = (t, ok=true)=>{ el("msg").textContent=t||""; el("msg").className=ok?"ok":"err"; };
const setEnrollMsg = (t, ok=true)=>{ el("enrollMsg").textContent=t||""; el("enrollMsg").className=ok?"ok":"err"; };

let currentUser = null;

/* ========= ADMIN LOGIN ========= */
el("btnLogin").addEventListener("click", async ()=>{
  setMsg("Logging in…");
  const email = el("email").value.trim();
  const password = el("pass").value;

  try{
    const { data, error } = await sb.auth.signInWithPassword({ email, password });
    if(error) return setMsg(error.message, false);
    if(!data?.session?.user) return setMsg("No session returned.", false);
    // session change handler will take over
    setMsg("");
  }catch(e){
    setMsg(e.message || "Login failed.", false);
  }
});

el("btnLogout").addEventListener("click", ()=> sb.auth.signOut());

/* ========= ROLE CHECK ========= */
async function assertAdmin(user){
  const { data, error } = await sb
    .from("profiles")
    .select("role,name")
    .eq("id", user.id)
    .maybeSingle();

  if(error) throw new Error(error.message);
  if(!data) throw new Error("Profile missing for this user. Add row in profiles with role=admin.");
  if((data.role || "").toLowerCase() !== "admin") throw new Error("This account is not admin.");
  return data;
}

/* ========= LOAD COURSES ========= */
async function loadCourses(){
  const { data, error } = await sb.from("courses").select("id,title").order("id",{ascending:true});
  if(error) throw new Error(error.message);

  el("courseId").innerHTML = (data||[]).map(c=>`<option value="${c.id}">${escapeHtml(c.title)} (id:${c.id})</option>`).join("");
}

/* ========= ENROLL ========= */
el("btnEnroll").addEventListener("click", async ()=>{
  setEnrollMsg("Enrolling…");
  const user_id = el("studentId").value.trim();
  const course_id = Number(el("courseId").value);
  const status = el("status").value;

  if(!user_id) return setEnrollMsg("Paste a student UUID (profiles.id).", false);

  const { error } = await sb.from("enrollments").insert([{
    user_id, course_id, status
  }]);

  if(error) return setEnrollMsg(error.message, false);

  setEnrollMsg("Enrolled ✅", true);
  el("studentId").value = "";
  await loadEnrollments();
});

/* ========= RECENT ENROLLMENTS ========= */
async function loadEnrollments(){
  el("enrollmentsBox").innerHTML = "<small>Loading…</small>";

  const { data, error } = await sb
    .from("enrollments")
    .select("id,user_id,course_id,status,created_at")
    .order("id",{ascending:false})
    .limit(20);

  if(error) return el("enrollmentsBox").innerHTML = `<p class="err">${escapeHtml(error.message)}</p>`;
  if(!data?.length) return el("enrollmentsBox").innerHTML = `<small>No enrollments yet.</small>`;

  el("enrollmentsBox").innerHTML = `
    <table>
      <thead><tr>
        <th>ID</th><th>User</th><th>Course</th><th>Status</th><th>Created</th>
      </tr></thead>
      <tbody>
        ${data.map(r=>`
          <tr>
            <td>${r.id}</td>
            <td><small>${escapeHtml(r.user_id)}</small></td>
            <td>${r.course_id}</td>
            <td><span class="tag">${escapeHtml(r.status||"")}</span></td>
            <td><small>${r.created_at ? new Date(r.created_at).toLocaleString() : "-"}</small></td>
          </tr>
        `).join("")}
      </tbody>
    </table>
  `;
}

function escapeHtml(s){
  return String(s || "").replace(/[&<>"']/g, (c) => ({
    "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;"
  }[c]));
}

/* ========= SESSION ========= */
sb.auth.onAuthStateChange(async (_, session)=>{
  try{
    if(session?.user){
      currentUser = session.user;

      // role check
      const p = await assertAdmin(currentUser);

      el("loginCard").classList.add("hidden");
      el("panelCard").classList.remove("hidden");
      el("who").textContent = `Logged in as ${session.user.email} (role: admin)`;

      await loadCourses();
      await loadEnrollments();
    }else{
      currentUser = null;
      el("panelCard").classList.add("hidden");
      el("loginCard").classList.remove("hidden");
      setMsg("");
    }
  }catch(err){
    // If not admin, sign out and show error
    await sb.auth.signOut();
    el("panelCard").classList.add("hidden");
    el("loginCard").classList.remove("hidden");
    setMsg(err.message || "Admin check failed.", false);
  }
});
</script>
</body>
</html>
