<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>LizOn Student Portal</title>
  <meta name="theme-color" content="#0b2a1f" />
  <link rel="manifest" href="/app.webmanifest">
  <link rel="icon" href="data:,">

  <style>
    :root{
      --bg:#06140f; --card:#0c2019; --line:#1d4a3a;
      --text:#e9f3ef; --muted:#b7c9c2; --gold:#d7b24a;
      --danger:#ff6b6b; --ok:#7CFFB2;
    }
    body{margin:0;font-family:system-ui,Segoe UI,Roboto,Arial;background:var(--bg);color:var(--text);}
    .wrap{max-width:980px;margin:0 auto;padding:22px;}
    .card{background:rgba(12,32,25,.92);border:1px solid var(--line);border-radius:16px;padding:18px;margin-top:16px;}
    .row{display:flex;gap:12px;flex-wrap:wrap;align-items:center}
    .between{display:flex;gap:12px;flex-wrap:wrap;align-items:center;justify-content:space-between}
    .btn{padding:12px 14px;border-radius:12px;border:1px solid var(--line);background:transparent;color:var(--text);cursor:pointer}
    .btn.primary{border-color:rgba(215,178,74,.7);box-shadow:0 0 0 1px rgba(215,178,74,.25) inset}
    .btn.danger{border-color:rgba(255,107,107,.6)}
    input, select{
      width:100%;padding:12px;border-radius:12px;border:1px solid var(--line);
      background:#071a14;color:var(--text);
    }
    label{display:block;margin-top:10px}
    small{color:var(--muted)}
    .hidden{display:none}
    .hr{height:1px;background:var(--line);margin:14px 0}
    .ok{color:var(--ok)}
    .err{color:var(--danger)}
    .grid{display:grid;grid-template-columns:repeat(2,minmax(0,1fr));gap:12px}
    @media (max-width:760px){ .grid{grid-template-columns:1fr} }
    .tag{display:inline-block;border:1px solid var(--line);padding:6px 10px;border-radius:999px;color:var(--muted)}
    .price{font-size:22px;font-weight:800}
  </style>
</head>

<body>
<div class="wrap">
  <h1>LizOn Education — Student Portal</h1>
  <small>Day 4 — Courses + Admit Now + Applications</small>

  <div style="text-align:right;margin-top:10px">
    <a class="btn" href="/admin.html">Admin Panel</a>
  </div>

  <!-- AUTH -->
  <div class="card" id="authCard">
    <h2>Login / Signup</h2>

    <div class="row">
      <button class="btn primary" id="tabLogin">Login</button>
      <button class="btn" id="tabSignup">Signup</button>
    </div>

    <div class="hr"></div>

    <div id="loginBox">
      <label>Email
        <input id="loginEmail" type="email">
      </label>
      <label>Password
        <input id="loginPass" type="password">
      </label>
      <div class="row" style="margin-top:12px">
        <button class="btn primary" id="btnLogin">Login</button>
      </div>
    </div>

    <div id="signupBox" class="hidden">
      <label>Full Name <input id="suName"></label>
      <label>Phone <input id="suPhone"></label>
      <label>Email <input id="suEmail" type="email"></label>
      <label>Password <input id="suPass" type="password"></label>
      <div class="row" style="margin-top:12px">
        <button class="btn primary" id="btnSignup">Create Account</button>
      </div>
    </div>

    <p id="msg"></p>
  </div>

  <!-- DASHBOARD -->
  <div class="card hidden" id="dashCard">
    <div class="between">
      <div>
        <h2 style="margin:0">Dashboard</h2>
        <small id="who"></small>
      </div>
      <button class="btn danger" id="btnLogout">Logout</button>
    </div>

    <div class="hr"></div>

    <div class="grid">
      <div class="card" style="margin-top:0">
        <h3>Your Profile</h3>
        <div id="profileView"></div>
      </div>
      <div class="card" style="margin-top:0">
        <h3>Help</h3>
        <a class="btn"
           target="_blank"
           href="https://api.whatsapp.com/send/?phone=8801611611139&text=Hi%2C+need+guidance+for+IELTS+Journey.">
          Talk with LizOn
        </a>
      </div>
    </div>

    <div class="hr"></div>

    <h3>Courses</h3>
    <div id="coursesBox"></div>

    <div class="hr"></div>

    <h3>My Applications</h3>
    <div id="appsBox"></div>
  </div>

  <!-- APPLY -->
  <div class="card hidden" id="applyCard">
    <div class="between">
      <div>
        <h2>Admit Now</h2>
        <small id="applyCourseName"></small>
      </div>
      <button class="btn" id="btnCloseApply">Close</button>
    </div>

    <label>Payment Method
      <select id="payMethod">
        <option>Bkash</option><option>Nagad</option><option>Rocket</option><option>Card</option>
      </select>
    </label>

    <label>Transaction ID <input id="trxId"></label>
    <label>Screenshot URL <input id="shotUrl"></label>

    <div class="row" style="margin-top:12px">
      <button class="btn primary" id="btnSubmitApply">Submit</button>
    </div>

    <p id="applyMsg"></p>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

<script>
const SUPABASE_URL = "https://swgerukvltraldtjueih.supabase.co";
const SUPABASE_ANON_KEY = "sb_publishable_RbWdA9MwSVNKqZ-Q4GWN3Q_iiOYFedG";
const supabase = supabasejs.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

const el = id => document.getElementById(id);
const msg = (t, ok=true)=>{ el("msg").textContent=t||""; el("msg").className=ok?"ok":"err"; };
const applyMsg = (t, ok=true)=>{ el("applyMsg").textContent=t||""; el("applyMsg").className=ok?"ok":"err"; };

let currentUser = null;
let selectedCourse = null;

/* APPLY SUBMIT — FIXED */
el("btnSubmitApply").onclick = async ()=>{
  applyMsg("Submitting…");

  try{
    if(!currentUser || !selectedCourse) throw "Session expired";

    const payload = {
      user_id: currentUser.id,
      course_id: selectedCourse.id,
      payment_method: el("payMethod").value,
      trx_id: el("trxId").value || null,
      screenshot_url: el("shotUrl").value || null,
      status: "pending"
    };

    const timeout = new Promise((_,rej)=>setTimeout(()=>rej("Timeout"),10000));
    const req = supabase.from("applications").insert([payload]);
    const { error } = await Promise.race([req, timeout]);

    if(error) throw error.message;

    applyMsg("Submitted successfully.", true);
    await loadMyApplications();
    setTimeout(()=>el("btnCloseApply").click(), 600);

  }catch(e){
    applyMsg(String(e), false);
  }
};

/* AUTH STATE */
supabase.auth.onAuthStateChange(async (_, session)=>{
  if(session?.user){
    currentUser = session.user;
    el("authCard").classList.add("hidden");
    el("dashCard").classList.remove("hidden");
    el("who").textContent = session.user.email;
    await loadCourses();
    await loadMyApplications();
  }
});
</script>
</body>
</html>
