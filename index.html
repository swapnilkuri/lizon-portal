<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>LizOn Portal</title>
  <meta name="theme-color" content="#0b2a1f" />
  <link rel="icon" href="data:,">

  <style>
    :root{
      --bg:#06140f; --card:#0c2019; --line:#1d4a3a;
      --text:#e9f3ef; --muted:#b7c9c2; --gold:#d7b24a;
      --danger:#ff6b6b; --ok:#7CFFB2;
    }
    body{margin:0;font-family:system-ui,Segoe UI,Roboto,Arial;background:var(--bg);color:var(--text);}
    .wrap{max-width:1050px;margin:0 auto;padding:22px;}
    .card{background:rgba(12,32,25,.92);border:1px solid var(--line);border-radius:16px;padding:18px;margin-top:16px;}
    .row{display:flex;gap:12px;flex-wrap:wrap;align-items:center}
    .between{display:flex;gap:12px;flex-wrap:wrap;align-items:center;justify-content:space-between}
    .btn{padding:12px 14px;border-radius:12px;border:1px solid var(--line);background:transparent;color:var(--text);cursor:pointer;text-decoration:none;display:inline-flex;align-items:center;gap:8px}
    .btn.primary{border-color:rgba(215,178,74,.7);box-shadow:0 0 0 1px rgba(215,178,74,.25) inset}
    .btn.danger{border-color:rgba(255,107,107,.6)}
    .btn.small{padding:10px 12px;border-radius:10px;font-size:14px}
    input, select{
      width:100%;padding:12px;border-radius:12px;border:1px solid var(--line);
      background:#071a14;color:var(--text);
    }
    label{display:block;margin-top:10px}
    small{color:var(--muted)}
    .hidden{display:none !important}
    .hr{height:1px;background:var(--line);margin:14px 0}
    .ok{color:var(--ok)}
    .err{color:var(--danger)}
    .grid{display:grid;grid-template-columns:repeat(2,minmax(0,1fr));gap:12px}
    @media (max-width:860px){ .grid{grid-template-columns:1fr} }
    .tag{display:inline-block;border:1px solid var(--line);padding:6px 10px;border-radius:999px;color:var(--muted);font-size:12px}
    .title{font-size:34px;margin:0}
    .mono{font-family:ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;}
  </style>
</head>

<body>
<div class="wrap">
  <div class="between">
    <div>
      <h1 class="title">LizOn Education — Portal</h1>
      <small>Student Dashboard (WhatsApp purchase → Admin enrolls → Access here)</small>
    </div>
    <div class="row">
      <button class="btn hidden" id="btnGoAdmin" type="button">Admin Panel</button>
      <button class="btn hidden danger" id="btnLogoutTop" type="button">Logout</button>
    </div>
  </div>

  <!-- AUTH -->
  <div class="card" id="authCard">
    <h2 style="margin-top:0">Login / Signup</h2>

    <div class="row">
      <button class="btn primary" id="tabLogin" type="button">Login</button>
      <button class="btn" id="tabSignup" type="button">Signup</button>
    </div>

    <div class="hr"></div>

    <!-- LOGIN -->
    <div id="loginBox">
      <label>Email
        <input id="loginEmail" type="email" placeholder="you@example.com" autocomplete="email">
      </label>
      <label>Password
        <input id="loginPass" type="password" placeholder="••••••••" autocomplete="current-password">
      </label>
      <div class="row" style="margin-top:12px">
        <button class="btn primary" id="btnLogin" type="button">Login</button>
      </div>
      <p><small>Note: If email confirmation is ON in Supabase, confirm email first, then login.</small></p>
    </div>

    <!-- SIGNUP -->
    <div id="signupBox" class="hidden">
      <label>Full Name
        <input id="suName" placeholder="Your full name" autocomplete="name">
      </label>
      <label>Phone
        <input id="suPhone" placeholder="01XXXXXXXXX" autocomplete="tel">
      </label>
      <label>Email
        <input id="suEmail" type="email" placeholder="you@example.com" autocomplete="email">
      </label>
      <label>Password
        <input id="suPass" type="password" placeholder="Create a password" autocomplete="new-password">
      </label>
      <div class="row" style="margin-top:12px">
        <button class="btn primary" id="btnSignup" type="button">Create Account</button>
      </div>
      <p><small>If Supabase email confirmation is ON, verify email before login.</small></p>
    </div>

    <p id="msg" style="margin-top:10px"></p>
  </div>

  <!-- STUDENT DASHBOARD -->
  <div class="card hidden" id="studentCard">
    <div class="between">
      <div>
        <h2 style="margin:0">Student Dashboard</h2>
        <small id="whoStudent"></small>
      </div>
      <button class="btn danger" id="btnLogoutStudent" type="button">Logout</button>
    </div>

    <div class="hr"></div>

    <div class="grid">
      <div class="card" style="margin-top:0">
        <h3 style="margin-top:0">Your Profile</h3>
        <div id="profileView"><small>Loading…</small></div>
      </div>

      <div class="card" style="margin-top:0">
        <h3 style="margin-top:0">Help</h3>
        <p style="margin:0 0 8px 0"><small>
          Purchase happens on WhatsApp. After payment, admin will enroll you.
        </small></p>
        <div class="row">
          <a class="btn"
             href="https://api.whatsapp.com/send/?phone=8801611611139&text=Hi%2C+need+guidance+for+IELTS+Journey.&type=phone_number&app_absent=0"
             target="_blank" rel="noopener">
            Talk with LizOn
          </a>
        </div>
      </div>
    </div>

    <div class="hr"></div>
    <h3 style="margin:0 0 10px 0">My Courses</h3>
    <div id="myCoursesBox"><small>Loading…</small></div>
  </div>

  <!-- ADMIN PANEL -->
  <div class="card hidden" id="adminCard">
    <div class="between">
      <div>
        <h2 style="margin:0">Admin Panel</h2>
        <small id="whoAdmin"></small>
      </div>
      <span class="tag">Admin only</span>
    </div>

    <div class="hr"></div>

    <div class="grid">
      <div class="card" style="margin-top:0">
        <h3 style="margin-top:0">Enroll Student</h3>

        <label>Student User ID (UUID) <small class="mono">(recommended)</small>
          <input id="studentUserId" placeholder="e.g. 8f8c0c7c-....">
        </label>

        <label>Select Course
          <select id="courseSelect"></select>
        </label>

        <label>Join Link (WhatsApp group / Zoom / Meet)
          <input id="joinLink" placeholder="https://chat.whatsapp.com/....">
        </label>

        <label>Class Record Link (Drive / YouTube playlist)
          <input id="recordLink" placeholder="https://drive.google.com/... or https://youtube.com/...">
        </label>

        <label>Status
          <select id="status">
            <option value="active">active</option>
            <option value="paused">paused</option>
          </select>
        </label>

        <div class="row" style="margin-top:12px">
          <button class="btn primary" id="btnEnroll" type="button">Enroll / Add Course</button>
        </div>

        <p id="adminMsg"></p>
        <small class="mono">Tip: Use Supabase Auth → Users → copy the user id.</small>
      </div>

      <div class="card" style="margin-top:0">
        <h3 style="margin-top:0">Notes</h3>
        <small>
          - Admin role is read from <span class="mono">profiles.role</span><br>
          - Students never see Admin Panel button<br>
          - Enrollments expected columns: <span class="mono">user_id, course_id, status, join_link, record_link</span><br>
          - courses expected: <span class="mono">id, slug, title, description</span>
        </small>
      </div>
    </div>
  </div>

</div>

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script>
/* ========= SUPABASE CONFIG (REPLACE ONLY THESE 2 LINES) ========= */
const SUPABASE_URL = "https://swgerukvltraldtjueih.supabase.co";
const SUPABASE_ANON_KEY = "sb_publishable_RbWdA9MwSVNKqZ-Q4GWN3Q_iiOYFedG";
/* =============================================================== */

const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

const el = (id) => document.getElementById(id);
const setMsg = (t, ok=true)=>{ el("msg").textContent=t||""; el("msg").className=ok?"ok":"err"; };
const setAdminMsg = (t, ok=true)=>{ el("adminMsg").textContent=t||""; el("adminMsg").className=ok?"ok":"err"; };

let currentUser = null;
let currentRole = "student";

/* ---------- helpers ---------- */
function escapeHtml(s){
  return String(s || "").replace(/[&<>"']/g, (c) => ({
    "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;"
  }[c]));
}
function showLogin(){
  el("loginBox").classList.remove("hidden");
  el("signupBox").classList.add("hidden");
  el("tabLogin").classList.add("primary");
  el("tabSignup").classList.remove("primary");
  setMsg("");
}
function showSignup(){
  el("signupBox").classList.remove("hidden");
  el("loginBox").classList.add("hidden");
  el("tabSignup").classList.add("primary");
  el("tabLogin").classList.remove("primary");
  setMsg("");
}

function showAuth(){
  el("authCard").classList.remove("hidden");
  el("studentCard").classList.add("hidden");
  el("adminCard").classList.add("hidden");
  el("btnGoAdmin").classList.add("hidden");
  el("btnLogoutTop").classList.add("hidden");
}
function showStudent(){
  el("authCard").classList.add("hidden");
  el("studentCard").classList.remove("hidden");
  el("adminCard").classList.add("hidden");
  el("btnLogoutTop").classList.remove("hidden");
  el("btnGoAdmin").classList.add("hidden"); // students never see it
}
function showAdmin(){
  el("authCard").classList.add("hidden");
  el("studentCard").classList.add("hidden");
  el("adminCard").classList.remove("hidden");
  el("btnLogoutTop").classList.remove("hidden");
  el("btnGoAdmin").classList.remove("hidden"); // admins see it
}

/* ---------- TAB EVENTS ---------- */
el("tabLogin").addEventListener("click", showLogin);
el("tabSignup").addEventListener("click", showSignup);

/* ---------- AUTH EVENTS ---------- */
el("btnLogin").addEventListener("click", async ()=>{
  setMsg("Logging in…");
  try{
    const email = el("loginEmail").value.trim();
    const password = el("loginPass").value;
    if(!email || !password) return setMsg("Email + password required.", false);

    const timeout = new Promise((_, rej) => setTimeout(()=>rej(new Error("Login timeout. Check internet / Supabase keys.")), 12000));
    const req = supabase.auth.signInWithPassword({ email, password });
    const { data, error } = await Promise.race([req, timeout]);

    if(error) return setMsg(error.message, false);
    if(!data?.session?.user) return setMsg("No session returned.", false);

    setMsg("");
    // UI will update via onAuthStateChange
  }catch(e){
    setMsg(e.message || "Login failed.", false);
  }
});

el("btnSignup").addEventListener("click", async ()=>{
  setMsg("Creating account…");
  try{
    const name = el("suName").value.trim();
    const phone = el("suPhone").value.trim();
    const email = el("suEmail").value.trim();
    const password = el("suPass").value;
    if(!name || !phone || !email || !password) return setMsg("All fields are required.", false);

    const { data, error } = await supabase.auth.signUp({ email, password });
    if(error) return setMsg(error.message, false);

    // Best-effort: create profiles row. (If RLS blocks, you'll see message.)
    if(data?.user){
      const { error: pErr } = await supabase.from("profiles").insert([{
        id: data.user.id,
        name,
        phone,
        role: "student"
      }]);
      if(pErr){
        return setMsg("Account created ✅ but profile insert blocked by RLS. Admin must create profile row once.", false);
      }
    }

    setMsg("Account created ✅. Now login.", true);
    showLogin();
  }catch(e){
    setMsg(e.message || "Signup failed.", false);
  }
});

/* ---------- LOGOUT (hard reset to avoid BFCache zombie) ---------- */
async function doLogout(){
  try{ await supabase.auth.signOut(); }
  finally{
    // Hard reload the current page to reset any cached state
    window.location.replace(window.location.pathname);
  }
}
el("btnLogoutStudent").addEventListener("click", doLogout);
el("btnLogoutTop").addEventListener("click", doLogout);

/* ---------- profile & courses loaders ---------- */
async function getRole(userId){
  const { data, error } = await supabase.from("profiles").select("role").eq("id", userId).maybeSingle();
  if(error) throw new Error(error.message);
  return (data?.role || "student");
}

async function loadMyProfile(){
  el("profileView").innerHTML = "<small>Loading…</small>";
  const { data, error } = await supabase
    .from("profiles")
    .select("name, phone, role")
    .eq("id", currentUser.id)
    .maybeSingle();

  if(error) return el("profileView").innerHTML = `<p class="err">${escapeHtml(error.message)}</p>`;
  if(!data) return el("profileView").innerHTML = `<p class="err">Profile not found. Admin can add your profile row once.</p>`;

  el("profileView").innerHTML = `
    <p><b>Name:</b> ${escapeHtml(data.name||"")}</p>
    <p><b>Phone:</b> ${escapeHtml(data.phone||"")}</p>
    <p><b>Role:</b> ${escapeHtml(data.role||"student")}</p>
  `;
}

async function loadMyCourses(){
  el("myCoursesBox").innerHTML = "<small>Loading…</small>";

  const { data, error } = await supabase
    .from("enrollments")
    .select(`
      course_id,
      status,
      join_link,
      record_link,
      courses:course_id ( id, slug, title, description )
    `)
    .eq("user_id", currentUser.id);

  if(error){
    return el("myCoursesBox").innerHTML = `<p class="err">${escapeHtml(error.message)}</p>`;
  }

  if(!data?.length){
    return el("myCoursesBox").innerHTML = `
      <div class="card" style="margin-top:12px">
        <p class="err" style="margin:0"><b>No courses assigned yet</b></p>
        <small>After payment, admin will enroll you and courses will appear here.</small>
      </div>
    `;
  }

  el("myCoursesBox").innerHTML = data.map(e => {
    const c = e.courses || {};
    const slug = (c.slug || "COURSE").toUpperCase();
    const title = c.title || "Course";
    const desc = c.description || "";
    const status = e.status || "active";
    const join = e.join_link || "";
    const rec = e.record_link || "";

    const joinBtn = join
      ? `<a class="btn primary jsExternal" href="${escapeHtml(join)}" target="_blank" rel="noopener noreferrer">Join the Class</a>`
      : `<span class="tag">Join link missing</span>`;

    const recBtn = rec
      ? `<a class="btn jsExternal" href="${escapeHtml(rec)}" target="_blank" rel="noopener noreferrer">Class Record</a>`
      : `<span class="tag">Record link missing</span>`;

    return `
      <div class="card" style="margin-top:12px">
        <div class="between">
          <div>
            <div class="tag">${escapeHtml(slug)}</div>
            <h3 style="margin:10px 0 6px 0">${escapeHtml(title)}</h3>
            <small>${escapeHtml(desc)}</small><br>
            <small>Status: ${escapeHtml(status)}</small>
          </div>
          <div class="row">
            ${joinBtn}
            ${recBtn}
          </div>
        </div>
      </div>
    `;
  }).join("");
}

/* ---------- admin loaders & actions ---------- */
async function loadCoursesForAdmin(){
  const sel = el("courseSelect");
  sel.innerHTML = `<option>Loading…</option>`;
  const { data, error } = await supabase.from("courses").select("id, slug, title").order("id",{ascending:true});
  if(error) throw new Error(error.message);
  sel.innerHTML = data.map(c => `<option value="${c.id}">${escapeHtml((c.slug||"").toUpperCase())} — ${escapeHtml(c.title||"")}</option>`).join("");
}

el("btnGoAdmin").addEventListener("click", async ()=>{
  // toggle admin view
  if(currentRole === "admin") showAdmin();
});

el("btnEnroll").addEventListener("click", async ()=>{
  setAdminMsg("Enrolling…");
  try{
    if(currentRole !== "admin") throw new Error("Not admin.");

    const user_id = el("studentUserId").value.trim();
    const course_id = Number(el("courseSelect").value);
    const join_link = el("joinLink").value.trim() || null;
    const record_link = el("recordLink").value.trim() || null;
    const status = el("status").value;

    if(!user_id) return setAdminMsg("Student User ID (UUID) required.", false);
    if(!course_id) return setAdminMsg("Course required.", false);
    if(!join_link && !record_link) return setAdminMsg("Add Join link or Record link (at least one).", false);

    const { error } = await supabase.from("enrollments").upsert([{
      user_id,
      course_id,
      status,
      join_link,
      record_link
    }], { onConflict: "user_id,course_id" });

    if(error) throw new Error(error.message);

    setAdminMsg("Enrolled ✅ (course added/updated).", true);
    el("joinLink").value = "";
    el("recordLink").value = "";
  }catch(e){
    setAdminMsg(e.message || "Enroll failed.", false);
  }
});

/* ---------- main refresh ---------- */
async function refreshUI(session){
  currentUser = session.user;
  currentRole = await getRole(currentUser.id);

  el("btnLogoutTop").classList.remove("hidden");

  if(currentRole === "admin"){
    el("whoAdmin").textContent = `Logged in as ${currentUser.email}`;
    el("btnGoAdmin").classList.remove("hidden");
    await loadCoursesForAdmin();
    showAdmin(); // admins land to admin panel
  } else {
    el("whoStudent").textContent = `Logged in as ${currentUser.email}`;
    showStudent();
    await loadMyProfile();
    await loadMyCourses();
  }
}

/* ---------- auth state ---------- */
supabase.auth.onAuthStateChange(async (_, session)=>{
  if(session?.user){
    try{
      await refreshUI(session);
    }catch(e){
      // if profile role fetch fails, show auth and message
      showAuth();
      setMsg(e.message || "Failed to load session.", false);
    }
  } else {
    currentUser = null;
    currentRole = "student";
    showAuth();
    showLogin();
  }
});

/* ---------- BFCache / returning from external links ---------- */
/* This is the main fix for: “Back to portal -> Loading… + logout dead” */
window.addEventListener("pageshow", async (e) => {
  // If restored from BFCache, re-bind state by refreshing session
  const { data } = await supabase.auth.getSession();
  if(data?.session?.user){
    await refreshUI(data.session);
  }
});

/* Also refresh when tab becomes visible again */
document.addEventListener("visibilitychange", async () => {
  if(document.visibilityState === "visible"){
    const { data } = await supabase.auth.getSession();
    if(data?.session?.user){
      await refreshUI(data.session);
    }
  }
});

/* Default view */
showAuth();
showLogin();
</script>
</body>
</html>
